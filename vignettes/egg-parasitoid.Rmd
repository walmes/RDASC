---
title: >
  Efeito de Inseticidas no Parasitismo de *Trichogramma* em Ovos de Lagartas da Soja
author: >
  [Tamara Akemi Takahashi](http://lattes.cnpq.br/0906035116528938) &
  [Walmes Zeviani](http://www.leg.ufpr.br/doku.php/pessoais:walmes)
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Efeito de Inseticidas no Parasitismo de Trichogramma em Ovos de Lagartas da Soja}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Definições da Sessão

```{r, message=FALSE, results="hide"}
#-----------------------------------------------------------------------
# Carregando pacotes e funções necessárias.

# https://github.com/walmes/wzRfun
# devtools::install_github("walmes/wzRfun")
library(wzRfun)
library(lattice)
library(latticeExtra)
library(plyr)
library(doBy)
library(multcomp)

gap <- function(groups, gap = NULL) {
    if (is.null(gap)) {
        gap <- 0.5/nlevels(groups)
    }
    d <- 2 * ((as.numeric(groups) - 1)/(nlevels(groups) - 1)) - 1
    return(gap * d)
}
```
```{r, eval=FALSE}
library(wzCoop)
```
```{r setup, include=FALSE}
source("config/setup.R")
```

****
## Análise Exploratória

Estes dados são resultados de um experimento fatorial triplo, conduzido
em laboratório, que estudou o efeito de 7 inseticidas no processo de pré
parasitismo de duas espécies de *Trichogramma* em duas espécies de
lagastas da soja (hospedeiros). Várias variáveis resposta foram
registradas com a finalidade de descrever o efeito dos inseticidas para
as espécies de parasitóide e hospedeiro, considerando por exemplo, o
tempo de vida da fêmea ovopositora, o tempo para eclosão dos ovos, a
razão sexual observada e a taxa de emergência dos ovos parasitados.

```{r}
#-----------------------------------------------------------------------
# Estrutura dos dados.

str(egg_parasitoid)

# levels(egg_parasitoid$inset)
# Português       Inglês
# Clorpirifós     Clorpyrifos
# Deltametrina    Deltamethrin
# Espinetoram     Spinetoram
# Flubendiamida   Flubendiamide
# Indoxacarbe     Indoxacarb
# Novalurom       Novaluron
# Testemunha      Control

l <- c("Clorpyrifos",
       "Deltamethrin",
       "Spinetoram",
       "Flubendiamide",
       "Indoxacarb",
       "Novaluron",
       "Control")

# Níveis dos fatores experimentais.
summary(egg_parasitoid[, 1:3])

# Usando nomes curtos para os níveis.
egg <- egg_parasitoid
levels(egg$inset) <- substr(l, 0, 5)
levels(egg$paras) <- c("Atopo", "Preti")
levels(egg$hosp) <- c("Anti", "Chry")

# Letra maiúscula para representar os fatores estudados.
names(egg)[1:3] <- c("I", "P", "H")

# Tabela de frequencia planejada do experimento (7 x 2 x 2 com 20 rep.).
ftable(xtabs(~I + P + H, data = egg))

# Tabela de frequência só para casos completos.
ftable(xtabs(~I + P + H, data = na.omit(egg)))
```

****
## Sobreviência da Fêmea

A sobreviência da fêmea, 24 horas após a liberação no tubo de ensaio
para parasitar os ovos, é representada por uma variável (`mort`)
dicotômica onde 1 indica que a fêmea sobreviveu e 0 que não não
sobreviveu. A variável `vivo` é o oposto da variável `mort`.

```{r}
# Desfechos de vivo: 1 = sobreviveu, 0 = não sobreviveu.
egg$vivo <- 1 - egg$mort
ftable(xtabs(vivo ~ I + P + H, data = egg))

# Como Clorpirifós e Testemunha são controles (-) e (+), onde a
# expectativa era nenhuma e total sobreviência, serão removidos da
# análise.

m0 <- glm(vivo ~ (I + P + H)^3,
          # data = subset(egg, !I %in% c("Test", "Clor", "Espi")),
          data = subset(egg),
          family = quasibinomial)
anova(m0, test = "F")

m1 <- update(m0, . ~ I * (P + H))
anova(m1, test = "F")
anova(m1, m0, test = "F")

#-----------------------------------------------------------------------
# Comparações entre hospedeiros dentro de inseticida x parasitóide.

lsm <- LSmatrix(m1, effect = c("I", "P", "H"))
grid <- equallevels(attr(lsm, "grid"), egg)

L <- by(lsm, INDICES = with(grid, interaction(I, P)), FUN = as.matrix)
L <- lapply(L, "rownames<-", levels(egg$H))

cmp <- lapply(L, apmc, model = m1, focus = "H")

pred <- ldply(cmp)
cmp <- ldply(strsplit(pred$.id, "\\."))
pred <- cbind(as.data.frame(cmp), pred[, -1])
names(pred)[1:2] <- names(grid)[1:2]

# Passa para a escala de probabilidade.
i <- c("fit", "lwr", "upr")
pred[, i] <- sapply(pred[, i], m1$family$linkinv)

# Ordena da tabela.
pred <- pred[with(pred, order(P, I, H)), ]

# Intervalos de confiança do tamanho do suporte terão apenas o ponto
# representado.
i <- pred$upr - pred$lwr > 0.99
if (any(i)) {
    pred[i, ]$lwr <- pred[i, ]$lwr <- NA
}

# Reordena os níveis pela probalidade de sobreviência.
pred$I <- reorder(pred$I, pred$fit)

# Legenda.
key <- list(points = list(pch = c(1, 19)),
            text = list(levels(egg_parasitoid$hosp)),
            title = "Parasitoids", cex.title = 1.1)

# Gráfico de segmentos.
segplot(I ~ lwr + upr | P,
        centers = fit,
        data = pred,
        xlab = "Insticides",
        ylab = "Probability of surviving a 24h period",
        draw = FALSE,
        horizontal = FALSE,
        groups = H,
        key = key,
        strip = strip.custom(
            factor.levels = levels(egg_parasitoid$paras)),
        gap = 0.15,
        panel = panel.groups.segplot,
        pch = key$points$pch[as.integer(pred$H)]) +
    layer(panel.text(y = centers[subscripts],
                     x = as.integer(z)[subscripts] + gap(groups, gap),
                     labels = pred$cld[subscripts],
                     adj = -0.25 * c(1, 1)))
```

****
## Ovos Parasitados

```{r}
#-----------------------------------------------------------------------

ftable(xtabs(complete.cases(egg) ~ I + H + P, data = egg))

# Remover Clorp e Spine pois tem informação inferior a metade com relação
# aos demais.

egg2 <- droplevels(subset(egg, !I %in% c("Clorp", "Spine")))
str(egg2)
```

```{r}
#-----------------------------------------------------------------------
# Análise exploratória.

ftable(xtabs(!is.na(opar) ~ I + P + H, data = egg2))
# ftable(xtabs(opar/otot ~ I + P + H, data = egg2))

useOuterStrips(xyplot(opar/otot ~ I | H + P,
                      data = egg2,
                      jitter.x = TRUE,
                      type = c("p", "a")))

#-----------------------------------------------------------------------
# Ajuste do modelo.

m0 <- glm(cbind(opar, otot - opar) ~ I * P * H,
          data = egg2,
          family = quasibinomial)

par(mfrow = c(2, 2))
plot(m0)
layout(1)

anova(m0, test = "F")
# summary(m0)

#-----------------------------------------------------------------------
# Comparações entre hospedeiros dentro de inseticida x parasitóide.

lsm <- LSmatrix(m0, effect = c("I", "P", "H"))
grid <- equallevels(attr(lsm, "grid"), egg2)

L <- by(lsm, INDICES = with(grid, interaction(I, P)), FUN = as.matrix)
L <- lapply(L, "rownames<-", levels(egg$H))

cmp <- lapply(L, apmc, model = m0, focus = "H")

pred <- ldply(cmp)
cmp <- ldply(strsplit(pred$.id, "\\."))
pred <- cbind(as.data.frame(cmp), pred[, -1])
names(pred)[1:2] <- names(grid)[1:2]

# Passa para a escala de probabilidade.
i <- c("fit", "lwr", "upr")
pred[, i] <- sapply(pred[, i], m0$family$linkinv)

# Ordena da tabela.
pred <- pred[with(pred, order(P, I, H)), ]

# Intervalos de confiança do tamanho do suporte terão apenas o ponto
# representado.
i <- pred$upr - pred$lwr > 0.99
if (any(i)) {
    pred[i, ]$lwr <- pred[i, ]$lwr <- NA
}

# Reordena os níveis pela probalidade de sobreviência.
pred$I <- reorder(pred$I, pred$fit)

# Legenda.
key <- list(points = list(pch = c(1, 19)),
            text = list(levels(egg_parasitoid$hosp)),
            title = "Parasitoids", cex.title = 1.1)

# Gráfico de segmentos.
segplot(I ~ lwr + upr | P,
        centers = fit,
        data = pred,
        xlab = "Insticides",
        ylab = "Proportion of parasited eggs",
        draw = FALSE,
        horizontal = FALSE,
        groups = H,
        key = key,
        strip = strip.custom(
            factor.levels = levels(egg_parasitoid$paras)),
        gap = 0.15,
        panel = panel.groups.segplot,
        pch = key$points$pch[as.integer(pred$H)]) +
    layer(panel.text(y = centers[subscripts],
                     x = as.integer(z)[subscripts] + gap(groups, gap),
                     labels = pred$cld[subscripts],
                     adj = -0.25 * c(1, 1)))
```

****
## Ovos Emergidos

```{r}
#-----------------------------------------------------------------------
# Análise exploratória.

ftable(xtabs(!is.na(oeme) ~ I + P + H, data = egg2))
# ftable(xtabs(oeme/otot ~ I + P + H, data = egg2))

useOuterStrips(xyplot(oeme/otot ~ I | H + P,
                      data = egg2[!is.na(egg2$oeme), ],
                      jitter.x = TRUE,
                      type = c("p", "a")))

#-----------------------------------------------------------------------
# Ajuste do modelo.

m0 <- glm(cbind(oeme, otot - oeme) ~ I * P * H,
          data = egg2,
          family = quasibinomial)

par(mfrow = c(2, 2))
plot(m0)
layout(1)

anova(m0, test = "F")

#-----------------------------------------------------------------------
# Comparações entre hospedeiros dentro de inseticida x parasitóide.

lsm <- LSmatrix(m0, effect = c("I", "P", "H"))
grid <- equallevels(attr(lsm, "grid"), egg2)

L <- by(lsm, INDICES = with(grid, interaction(I, P)), FUN = as.matrix)
L <- lapply(L, "rownames<-", levels(egg$H))

cmp <- lapply(L, apmc, model = m0, focus = "H")

pred <- ldply(cmp)
cmp <- ldply(strsplit(pred$.id, "\\."))
pred <- cbind(as.data.frame(cmp), pred[, -1])
names(pred)[1:2] <- names(grid)[1:2]

# Passa para a escala de probabilidade.
i <- c("fit", "lwr", "upr")
pred[, i] <- sapply(pred[, i], m0$family$linkinv)

# Ordena da tabela.
pred <- pred[with(pred, order(P, I, H)), ]

# Intervalos de confiança do tamanho do suporte terão apenas o ponto
# representado.
i <- pred$upr - pred$lwr > 0.99
if (any(i)) {
    pred[i, ]$lwr <- pred[i, ]$lwr <- NA
}

# Reordena os níveis pela probalidade de sobreviência.
pred$I <- reorder(pred$I, pred$fit)

# Legenda.
key <- list(points = list(pch = c(1, 19)),
            text = list(levels(egg_parasitoid$hosp)),
            title = "Parasitoids", cex.title = 1.1)

# Gráfico de segmentos.
segplot(I ~ lwr + upr | P,
        centers = fit,
        data = pred,
        xlab = "Insticides",
        ylab = "Probability of egg emergency",
        draw = FALSE,
        horizontal = FALSE,
        groups = H,
        key = key,
        strip = strip.custom(
            factor.levels = levels(egg_parasitoid$paras)),
        gap = 0.15,
        panel = panel.groups.segplot,
        pch = key$points$pch[as.integer(pred$H)]) +
    layer(panel.text(y = centers[subscripts],
                     x = as.integer(z)[subscripts] + gap(groups, gap),
                     labels = pred$cld[subscripts],
                     adj = -0.25 * c(1, 1)))
```

****
## Tempo de Incubação dos Parasitóides

Essa variável apresenta pouca variação para algumas celas, portanto não
informação suficiente para ser analisada.

****
## Razão Sexual

```{r}
#-----------------------------------------------------------------------
# Análise exploratória.

useOuterStrips(xyplot(femea + macho ~ I | H + P,
                      data = egg2[!is.na(egg2$macho + egg2$femea), ],
                      jitter.x = TRUE,
                      auto.key = TRUE,
                      type = c("p", "a")))

#-----------------------------------------------------------------------
# Ajuste do modelo.

m0 <- glm(cbind(femea, macho) ~ I * P * H,
          data = egg2,
          family = quasibinomial)

par(mfrow = c(2, 2))
plot(m0)
layout(1)

anova(m0, test = "F")
# summary(m0)

m1 <- glm(cbind(femea, macho) ~ P * H,
          data = egg2,
          family = quasibinomial)

par(mfrow = c(2, 2))
plot(m1)
layout(1)

anova(m0, m1, test = "F")
anova(m1, test = "F")
# summary(m1)

#-----------------------------------------------------------------------
# Comparações entre hospedeiros dentro de inseticida x parasitóide.

lsm <- LSmatrix(m1, effect = c("P", "H"))
grid <- equallevels(attr(lsm, "grid"), egg2)

L <- by(lsm, INDICES = with(grid, P), FUN = as.matrix)
L <- lapply(L, "rownames<-", levels(egg2$H))

cmp <- lapply(L, apmc, model = m1, focus = "H")

pred <- ldply(cmp)
# cmp <- ldply(strsplit(pred$.id, "\\."))
# pred <- cbind(as.data.frame(cmp), pred[, -1])
names(pred)[1] <- names(grid)[1]
pred <- equallevels(pred, egg2)

# Passa para a escala de probabilidade.
i <- c("fit", "lwr", "upr")
pred[, i] <- sapply(pred[, i], m0$family$linkinv)

# Ordena da tabela.
pred <- pred[with(pred, order(P, H)), ]

# Intervalos de confiança do tamanho do suporte terão apenas o ponto
# representado.
i <- pred$upr - pred$lwr > 0.99
if (any(i)) {
    pred[i, ]$lwr <- pred[i, ]$lwr <- NA
}

# Legenda.
key <- list(points = list(pch = c(1, 19)),
            text = list(levels(egg_parasitoid$hosp)),
            title = "Parasitoids", cex.title = 1.1)

# Gráfico de segmentos.
segplot(P ~ lwr + upr,
        centers = fit,
        data = pred,
        xlab = "Host species",
        ylab = "Proportion of female parasitoids",
        draw = FALSE,
        horizontal = FALSE,
        groups = H,
        key = key,
        strip = strip.custom(
            factor.levels = levels(egg_parasitoid$paras)),
        gap = 0.15,
        panel = panel.groups.segplot,
        pch = key$points$pch[as.integer(pred$H)]) +
    layer(panel.text(y = centers[subscripts],
                     x = as.integer(z)[subscripts] + gap(groups, gap),
                     labels = pred$cld[subscripts],
                     adj = -0.25 * c(1, 1)))
```

****
## Razão de Emergência dos Parasitóides

```{r}
#-----------------------------------------------------------------------
# Análise exploratória.

egg2$pem <- with(egg2, femea + macho)

useOuterStrips(xyplot(pem + pne ~ I | H + P,
                      data = egg2[!is.na(egg2$pem + egg2$pne), ],
                      jitter.x = TRUE,
                      auto.key = TRUE,
                      type = c("p", "a")))

#-----------------------------------------------------------------------
# Ajuste do modelo.

m0 <- glm(cbind(pem, pne) ~ I * P * H,
          data = egg2,
          family = quasibinomial)

par(mfrow = c(2, 2))
plot(m0)
layout(1)

anova(m0, test = "F")
# summary(m0)

#-----------------------------------------------------------------------
# Comparações entre hospedeiros dentro de inseticida x parasitóide.

lsm <- LSmatrix(m0, effect = c("I", "P", "H"))
grid <- equallevels(attr(lsm, "grid"), egg2)

L <- by(lsm, INDICES = with(grid, interaction(I, P)), FUN = as.matrix)
L <- lapply(L, "rownames<-", levels(egg2$H))

cmp <- lapply(L, apmc, model = m0, focus = "H")

pred <- ldply(cmp)
cmp <- ldply(strsplit(pred$.id, "\\."))
pred <- cbind(as.data.frame(cmp), pred[, -1])
names(pred)[1:2] <- names(grid)[1:2]

# Passa para a escala de probabilidade.
i <- c("fit", "lwr", "upr")
pred[, i] <- sapply(pred[, i], m0$family$linkinv)

# Ordena da tabela.
pred <- pred[with(pred, order(P, I, H)), ]

# Intervalos de confiança do tamanho do suporte terão apenas o ponto
# representado.
i <- pred$upr - pred$lwr > 0.99
if (any(i)) {
    pred[i, ]$lwr <- pred[i, ]$lwr <- NA
}

# Reordena os níveis pela probalidade de sobreviência.
pred$I <- reorder(pred$I, pred$fit)

# Legenda.
key <- list(points = list(pch = c(1, 19)),
            text = list(levels(egg_parasitoid$hosp)),
            title = "Parasitoids", cex.title = 1.1)

# Gráfico de segmentos.
segplot(I ~ lwr + upr | P,
        centers = fit,
        data = pred,
        xlab = "Insticides",
        ylab = "Probability of surviving a 24h period",
        draw = FALSE,
        horizontal = FALSE,
        groups = H,
        key = key,
        strip = strip.custom(
            factor.levels = levels(egg_parasitoid$paras)),
        gap = 0.15,
        panel = panel.groups.segplot,
        pch = key$points$pch[as.integer(pred$H)]) +
    layer(panel.text(y = centers[subscripts],
                     x = as.integer(z)[subscripts] + gap(groups, gap),
                     labels = pred$cld[subscripts],
                     adj = -0.25 * c(1, 1)))
```

****
## Total de Parasitóides

```{r}
#-----------------------------------------------------------------------
# Análise exploratória.

egg2$ptot <- with(egg2, femea + macho + pne)

useOuterStrips(xyplot(ptot ~ I | H + P,
                      data = egg2[!is.na(egg2$ptot), ],
                      jitter.x = TRUE,
                      auto.key = TRUE,
                      type = c("p", "a")))

#-----------------------------------------------------------------------
# Ajuste do modelo.

m0 <- glm(ptot ~ I * P * H,
          data = egg2,
          family = quasipoisson)

par(mfrow = c(2, 2))
plot(m0)
layout(1)

anova(m0, test = "F")
# summary(m0)

#-----------------------------------------------------------------------
# Comparações entre hospedeiros dentro de inseticida x parasitóide.

lsm <- LSmatrix(m0, effect = c("I", "P", "H"))
grid <- equallevels(attr(lsm, "grid"), egg2)

L <- by(lsm, INDICES = with(grid, interaction(I, P)), FUN = as.matrix)
L <- lapply(L, "rownames<-", levels(egg2$H))

cmp <- lapply(L, apmc, model = m0, focus = "H")

pred <- ldply(cmp)
cmp <- ldply(strsplit(pred$.id, "\\."))
pred <- cbind(as.data.frame(cmp), pred[, -1])
names(pred)[1:2] <- names(grid)[1:2]

# Passa para a escala de probabilidade.
i <- c("fit", "lwr", "upr")
pred[, i] <- sapply(pred[, i], m0$family$linkinv)

# Ordena da tabela.
pred <- pred[with(pred, order(P, I, H)), ]

# Reordena os níveis pela probalidade de sobreviência.
pred$I <- reorder(pred$I, pred$fit)

# Legenda.
key <- list(points = list(pch = c(1, 19)),
            text = list(levels(egg_parasitoid$hosp)),
            title = "Parasitoids", cex.title = 1.1)

# Gráfico de segmentos.
segplot(I ~ lwr + upr | P,
        centers = fit,
        data = pred,
        xlab = "Insticides",
        ylab = "Total of parasitoids",
        draw = FALSE,
        horizontal = FALSE,
        groups = H,
        key = key,
        strip = strip.custom(
            factor.levels = levels(egg_parasitoid$paras)),
        gap = 0.15,
        panel = panel.groups.segplot,
        pch = key$points$pch[as.integer(pred$H)]) +
    layer(panel.text(y = centers[subscripts],
                     x = as.integer(z)[subscripts] + gap(groups, gap),
                     labels = pred$cld[subscripts],
                     adj = -0.25 * c(1, 1)))
```

****
## Session information

```{r, echo=FALSE, results="hold"}
cat(format(Sys.time(), format = "%A, %d de %B de %Y, %H:%M"),
    "----------------------------------------", sep = "\n")
sessionInfo()
```

```{r, eval=FALSE, include=FALSE}
# Log-verossimilhança para binomial.
ll <- function(p, y, size) {
    sum(dbinom(x = y, size = size, prob = p, log = TRUE))
}

# Dados observados (amostra pequena).
y <- 20
size <- 20

# Grid de valores de p e sua ll correspondente.
p <- seq(0.01, 0.99, by = 0.01)
l <- sapply(p, FUN = ll, y = y, size = size)

# Gráfico e IC baseado em corte da LL.
plot(l ~ p, type = "l")
abline(h = max(l) - 2 * qchisq(0.95, 1), v = 0.67, col = 2)

# Agora com uma amostra bem ainda maior.
y <- 200
size <- 200

# Grid de valores de p e sua ll correspondente.
p <- seq(0.01, 0.99, by = 0.01)
l <- sapply(p, FUN = ll, y = y, size = size)

# Gráfico e IC baseado em corte da LL.
plot(l ~ p, type = "l")
abline(h = max(l) - 2 * qchisq(0.95, 1), v = 0.95, col = 2)

#-----------------------------------------------------------------------
```

```{r, eval = FALSE, include = FALSE}
library(arm)

# Cauchy(0, 1) prior.
m0 <- bayesglm(mort ~ (I + P + H)^2,
               data = subset(egg, !I %in% c("Test", "Clor")),
               family = quasibinomial)
summary(m0)
anova(m0, test = "Chisq")

# display(m0)
# show(m0)
# class(m0)


# m0$data
# names(m0$xlevels)
# str(m0)
# formula(m0)

X <- unique(model.matrix(m0))
V <- vcov(m0)
b <- coef(m0)

str(b)
str(X)

X %*% b
sqrt(diag(X %*% V %*% t(X)))

predict(m0)
methods(class = class(m0))

help(predict.bayesglm)

predict(m0, newdata = pred)
predict(m0)

#-----------------------------------------------------------------------
```
